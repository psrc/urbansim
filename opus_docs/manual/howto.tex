% $Id: howto.tex,v 1.17 2007/06/01 23:49:22 borning Exp $

% Copyright (c) 2005-2007 Center for Urban Simulation and Policy Analysis,
% University of Washington.  Permission is granted to copy, distribute and/or
% modify this document under the terms of the GNU Free Documentation License,
% Version 1.2 or any later version published by the Free Software Foundation;
% with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
% A copy of the license is included in the section entitled "GNU Free
% Documentation License".

\chapter{How To}

This section contains answers to ``how to'' questions, as well as other
bits of Opus and UrbanSim lore.  Some of this material is specific to the Puget
Sound Regional Council \psrcindex application of UrbanSim, but we hope that some
of this material may nevertheless be useful to others (with appropriate
conversion to the different context).

If you have additional questions you would like answered, please submit them to 
the UrbanSim users mail list:
% ** two versions of email address - avoid a real one for the html pages so that
% we aren't such a spam magnet
%begin{latexonly}
\email{users@urbansim.org}.
%end{latexonly}
\begin{htmlonly}
{\tt users (at) urbansim.org}
\end{htmlonly}

\section{Running a Python Script as a Windows Service}
\pythonindex\windowsindex
 
Solution found on this blog: 
\url{http://agiletesting.blogspot.com/2005/09/running-python-script-as-windows.html}

Suppose you want to turn a script called \file{myscript.py} into a service.

\begin{enumerate}

\item Install Win2K \windowsindex Resource Kit (or copy the 2 binaries 
\file{instsrv.exe} and \file{srvany.exe}). The full Resource Kit can be 
found here: \\
	  {\small \code{http://www.microsoft.com/downloads/details.aspx?\\
	  				familyid=9d467a69-57ff-4ae7-96ee-b18c4790cffd\&displaylang=en}}

\item Run {\bf instsrv} to install \file{srvany.exe} as a service with the 
name {\it myscript}: \\
	  {\small \code{"C:\textbackslash Program Files\textbackslash Windows Resource Kits\textbackslash Tools\textbackslash instsrv" 
	  			   myscript "C:\textbackslash Program Files\textbackslash Windows Resource Kits\textbackslash Tools\textbackslash srvany.exe"}} \windowsindex

\item Go to \code{Computer Management $\rightarrow$ Services} or \code{Control Panel $\rightarrow$ Administrative Tools $\rightarrow$ Services}
      and make sure {\it myscript} is listed as a service. Make sure the Startup Type is Automatic. Also make sure that the service has the right permissions to 
      access applications in your computer by double clicking on {\it myscript} and going to \verb|Log On|.

\item Create a \file{myscript.bat} file in 
e.g.\ \code{C:\textbackslash pyscripts} with the following contents: \\
	  \code{C:\textbackslash Python24\textbackslash python C:\textbackslash pyscripts\textbackslash myscript.py} \pythonindex
	  (replace Python24 \pythonversionindex with your Python \pythonindex version) 

\item Create new registry entries for the new service.
	\begin{itemize}
	    \item run {\bf regedt32} and go to the \\ 
	    	  \code{HKEY_LOCAL_MACHINE\textbackslash SYSTEM\textbackslash CurrentControlDataset\textbackslash Services\textbackslash myscript} entry
    	\item add new key \code{(Edit $\rightarrow$ Add Key)} called {\bf Parameters}
    	\item add new entry for Parameters key \code{(Edit $\rightarrow$ Add Value)} to set the Application name
           \begin{itemize}
           		\item \verb|Name| should be {\bf Application}
           		\item \verb|Type| should be {\bf REG_SZ} 
           		\item \verb|Value| should be path to myscript.bat, 
           			  i.e. {\bf \code{C:\textbackslash pyscripts\textbackslash myscript.bat}}
    		\end{itemize}
    	\item add new entry for Parameters key \code{(Edit $\rightarrow$ Add Value)} to set the working directory
           \begin{itemize}           
 	       		\item \verb|Name| should be {\bf AppDir}
        	  	\item \verb|Type| should be {\bf REG_SZ} 
      	    	\item \verb|Value| should be path to pyscripts directory, i.e. {\bf \code{C:\textbackslash pyscripts}}
      	    \end{itemize} 
	\end{itemize}

\item Reboot your computer.

\item Test starting and stopping the myscript service in 
	\code{Computer Management $\rightarrow$ Services} or \code{Control Panel $\rightarrow$ Administrative Tools $\rightarrow$ Services}
\end{enumerate}

\section{Creating a Baseyear Database that Contains just a Portion 
of a Baseyear Database}

It sometimes is convenient to have a small subset of a baseyear that you can 
use for testing whether the system is behaving appropriately.  We have a tool 
to create such as subset by giving either the city or county name.  It's a bit
hard coded to the PSRC \psrcindex use, but you can modify it for your application. 
\emph{TODO: Clean up this module so that it isn't hard coded to PSRC.}

Use the \module{create_database_subset_by_city_or_county.py} module in 
\module{urbansim.tools}. Fill in input database name near the bottom (for 
example, \file{PSRC_2000_baseyear}). \psrcindex  Edit the values of the 
\verb|DB_server_setting| to be your values. Then execute this module with an 
argument that is a city name or a county name. To create a subset of Seattle,
only, use the command:
\pythonindex
\begin{verbatim}
> python create_database_subset_by_city_or_county.py city seattle 
\end{verbatim}